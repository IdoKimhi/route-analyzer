{% extends "base.html" %}
{% block content %}

<h1>Home</h1>

<section class="card">
  <div class="controls">
    <div>
      <label>Route</label>
      <select id="homeRoute">
        {% if routes %}
          {% for r in routes %}
            <option value="{{ r.id }}" {% if default_route and r.id == default_route.id %}selected{% endif %}>
              {{ r.name }} ({{ "on" if r.enabled else "off" }})
            </option>
          {% endfor %}
        {% else %}
          <option value="">No routes</option>
        {% endif %}
      </select>
    </div>
  </div>

  {% if routes %}
    <div id="map" class="map"></div>
  {% else %}
    <div class="hint">No routes configured. Go to <a href="{{ url_for('setup') }}">/setup</a>.</div>
  {% endif %}
</section>

<section class="grid2">
  <div class="card">
    <h2>Provider status (selected route)</h2>
    <div id="providerStatus" class="hint">Select a route</div>
  </div>

  <div class="card">
    <h2>Last 24 hours (selected route)</h2>
    <canvas id="homeChart" height="120"></canvas>
  </div>
</section>

<script>
  window.__lastByRoute = {
    {% for rid, d in last_by_route.items() %}
      "{{ rid }}": {
        waze: {{ "null" if not d.waze else ("{ts: '%s', status: '%s', eta: %s, err: %s}" % (
          d.waze.ts_utc.isoformat(),
          d.waze.status,
          (d.waze.duration_sec // 60) if d.waze.duration_sec else "null",
          ("'%s'" % d.waze.error.replace("'", "\\'")) if d.waze.error else "null"
        )) | safe }},
        osrm: {{ "null" if not d.osrm else ("{ts: '%s', status: '%s', eta: %s, err: %s}" % (
          d.osrm.ts_utc.isoformat(),
          d.osrm.status,
          (d.osrm.duration_sec // 60) if d.osrm.duration_sec else "null",
          ("'%s'" % d.osrm.error.replace("'", "\\'")) if d.osrm.error else "null"
        )) | safe }}
      },
    {% endfor %}
  };
</script>

{% endblock %}
